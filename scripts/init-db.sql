-- Initialize Wayfinder Database Schema for Oracle 12c+
-- This script runs automatically when the Oracle container starts

-- Create Users table
CREATE TABLE USERS (
    ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    EMAIL VARCHAR2(255) NOT NULL UNIQUE,
    PASSWORD_HASH VARCHAR2(255) NOT NULL,
    COLOR1 VARCHAR2(7),
    COLOR2 VARCHAR2(7),
    COLOR3 VARCHAR2(7),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP
);

-- Create Tasks table
CREATE TABLE TASKS (
    ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    TITLE VARCHAR2(255) NOT NULL,
    USER_ID NUMBER NOT NULL,
    LAST_FINISHED_DATE TIMESTAMP,
    REFRESH_INTERVAL NUMBER DEFAULT 1,
    ALERT_THRESHOLD_PERCENTAGE NUMBER DEFAULT 80,
    IS_ACTIVE NUMBER(1) DEFAULT 1,
    INITIAL_REFRESH_INTERVAL NUMBER DEFAULT 1,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP,
    CONSTRAINT FK_TASKS_USER FOREIGN KEY (USER_ID) REFERENCES USERS(ID) ON DELETE CASCADE
);

-- Create Tags table
-- Per requirements: "Tag (name, Task id)" - direct one-to-many relationship with Task
CREATE TABLE TAGS (
    ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    NAME VARCHAR2(100) NOT NULL,
);

-- Create TaskTags table for many-to-many relationships
-- Per requirements: "TaskTag (Task id, Tag id)" - enables associating tags across multiple tasks
CREATE TABLE TASK_TAGS (
    ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    TASK_ID NUMBER NOT NULL,
    TAG_ID NUMBER NOT NULL,
    CONSTRAINT FK_TASKTAGS_TASK FOREIGN KEY (TASK_ID) REFERENCES TASKS(ID) ON DELETE CASCADE,
    CONSTRAINT FK_TASKTAGS_TAG FOREIGN KEY (TAG_ID) REFERENCES TAGS(ID) ON DELETE CASCADE,
    CONSTRAINT UQ_TASKTAGS UNIQUE (TASK_ID, TAG_ID)
);

-- Create Records table
CREATE TABLE RECORDS (
    ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    TASK_ID NUMBER NOT NULL,
    FINISHED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    STATUS ENUM('Too Early', 'On Time', 'Too Late') NOT NULL,
    CONSTRAINT FK_RECORDS_TASK FOREIGN KEY (TASK_ID) REFERENCES TASKS(ID) ON DELETE CASCADE
);

-- Create indexes for better performance
CREATE INDEX IDX_USERS_EMAIL ON USERS(EMAIL);
CREATE INDEX IDX_TASKS_USER_ID ON TASKS(USER_ID);
CREATE INDEX IDX_TAGS_TASK_ID ON TAGS(TASK_ID);
CREATE INDEX IDX_RECORDS_TASK_ID ON RECORDS(TASK_ID);
CREATE INDEX IDX_TASKTAGS_TASK_ID ON TASK_TAGS(TASK_ID);
CREATE INDEX IDX_TASKTAGS_TAG_ID ON TASK_TAGS(TAG_ID);

-- Grant privileges to the wayfinder user (if running as different user)
-- GRANT ALL ON USERS TO wayfinder;
-- GRANT ALL ON TASKS TO wayfinder;
-- GRANT ALL ON TAGS TO wayfinder;
-- GRANT ALL ON TASK_TAGS TO wayfinder;
-- GRANT ALL ON RECORDS TO wayfinder;

COMMIT;
